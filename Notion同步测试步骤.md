# Notion 同步功能 — 测试步骤

按下面顺序做一遍，即可验证「数据仅存你的 Notion、最低权限、0 成本」是否正常。

---

## 前提：能访问到「代理接口」

Notion 同步需要请求 `/api/notion-proxy`，所以必须在**有后端的环境**下测试：

- **方式 A（推荐）**：项目已部署在 Vercel，用部署后的网址（如 `https://xxx.vercel.app`）在浏览器里打开并测试。
- **方式 B**：本地用 `vercel dev` 跑一遍，浏览器访问 `http://localhost:3000` 等本地地址进行测试。

用「直接双击打开 `index.html`」的方式无法调用接口，会提示需在部署后的网址使用。

---

## 第 1 步：在 Notion 里创建集成并拿到密钥

1. 浏览器打开：**https://www.notion.so/my-integrations**
2. 登录 Notion 后，点 **「+ 新建集成」**。
3. **名称** 随便填（如「存货小管家」），**关联空间** 选你常用的那个。
4. 点 **「提交」**，进入集成详情页。
5. 在 **「密钥」** 区域，点 **「显示」** 或 **「复制」**，复制整串以 `secret_` 开头的密钥，保存到记事本（后面在应用里粘贴）。

**说明**：集成创建后，默认**看不到任何页面**，只有你把某个页面/数据库「连接」或「共享」给这个集成后，它才能访问，符合「最低权限」。

---

## 第 2 步：在 Notion 里准备「一个数据库」

任选其一即可。

### 方式 A：让应用帮你创建数据库（推荐）

1. 在 Notion 里**新建一个空白页面**（如名字叫「存货」）。
2. 打开这个页面，点右上角 **「⋯」** → **「连接」**（或「添加连接」）→ 选择你刚创建的集成（如「存货小管家」）→ 连接。
3. 复制浏览器地址栏里的**页面 ID**：  
   URL 形如 `https://www.notion.so/我的空间/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`，最后那串 32 位英文+数字就是页面 ID（有横线也可以，应用会自动去掉）。  
   例如：`a1b2c3d4e5f6789012345678abcdef12`
4. 打开**存货小管家**（部署后的网址）→ **设置** → 在 **「Notion 集成密钥」** 里粘贴你的 `secret_xxx`。
5. 在 **「或创建新数据库：父页面 ID」** 里粘贴上一步的**页面 ID**，点 **「创建『存货小管家』数据库」**。
6. 若成功，**「Notion 数据库 ID」** 会自动被填好。
7. 回到 Notion，刷新或打开「存货」页面，下面会出现一个新数据库「存货小管家」。点进该数据库，再点右上角 **「连接」**，把**这个数据库**也连接到你刚创建的集成（若已连接父页面，有时子数据库已可访问，若接口报 403 再连一次数据库即可）。

### 方式 B：自己先建数据库再填 ID

1. 在 Notion 里**新建一个数据库**（表格/看板均可），命名为「存货小管家」或任意名字。
2. 打开该数据库页面，点 **「⋯」** → **「连接」** → 选择你的集成，连接。
3. 从浏览器地址栏复制**数据库 ID**：  
   URL 形如 `https://www.notion.so/xxx?v=yyy`，`xxx` 通常是 32 位 id（有时中间带横线）。  
   若 URL 是 `https://www.notion.so/abc123...`，则 id 就是 `abc123...` 这一段（共 32 位）。
4. 在存货小管家 **设置** 里：**Notion 集成密钥** 填 `secret_xxx`，**Notion 数据库 ID** 填刚复制的 id。
5. **注意**：若数据库是你手建的，属性名需和本应用约定一致（名称、品牌、一级品类、二级品类、数量、购买日期、到期日、单价、备注、状态、用完时间、提前提醒天、本地ID），否则同步可能错乱。**建议用方式 A 让应用创建**，属性会自动对齐。

---

## 第 3 步：在应用里开启同步并拉数据

1. 在设置里勾选 **「启用 Notion 同步」**。
2. 确认 **Notion 集成密钥** 和 **Notion 数据库 ID** 已填好，保存（失焦或切到别的输入框即可）。
3. 点底部 **「库存」** 或 **「首页」**：应用会请求 `/api/notion-proxy` 从你的 Notion 拉数据。
4. 若之前数据库是空的，列表应为空；若 Notion 里已有行，会显示在库存列表里。

**若报错**：「拉取 Notion 数据失败」→ 检查：  
- 该数据库（及父页面，若用方式 A）是否已「连接」到你的集成；  
- 密钥、数据库 ID 是否完整无误；  
- 是否在**部署后的网址**或 `vercel dev` 下测试（不能是 `file://`）。

---

## 第 4 步：测试「新增」「编辑」「删除」「用完了」

- **新增**：在库存页点 **「进货」**，填一条测试数据保存 → 到 Notion 里打开该数据库，应多出一行，且字段与表单一致。
- **编辑**：在库存里点某条 **「编辑」**，改名称或数量后保存 → Notion 里对应行应更新。
- **删除**：在库存里点 **「删除」**，确认 → Notion 里该行会变为「已归档」（在 Notion 里仍可在归档中查看）。
- **用完了**：选一条在库的，点 **「用完了」**，填数量确定 → 该条数量减少或变为 0，并多出一条「已用完」记录；Notion 里应对应多一行、状态为「已用完」。

---

## 第 5 步：确认「服务器不存数据」

- 你的密钥和存货内容只在你浏览器与 Notion 之间经 Vercel 代理**转发**；  
- 代理代码（`api/notion-proxy.js`）里**没有**数据库写入、没有把 token 或请求体写入日志或存储。  
- 可在 Vercel 项目 **Deployments → 某次部署 → Functions → notion-proxy** 查看运行日志：只有请求是否成功等信息，不应包含你的 Secret 或具体存货内容。

---

## 小结

| 步骤 | 做什么 |
|------|--------|
| 1 | Notion 创建集成，复制 `secret_xxx` |
| 2 | 用「创建数据库」或手建数据库，并**连接**到该集成，拿到数据库 ID |
| 3 | 应用设置里填密钥 + 数据库 ID，勾选启用 Notion 同步，进库存/首页拉数据 |
| 4 | 测试增删改、用完了，并在 Notion 里核对 |
| 5 | 可选：看 Vercel 函数日志确认无敏感数据留存 |

全部通过即说明：数据只存在你的 Notion、权限最小、且当前方案 0 成本可用。
