# 邮件发送配置说明

> **推荐使用 Gmail**：可发往**任意用户填写的邮箱**（不限于你自己）。Resend 免费版可能仅支持发往已验证/注册邮箱，多用户场景请用 Gmail。  
> 下面分「手动发送」与「定期自动发送」两种用途说明配置。

---

## 一、Gmail 配置（推荐，可发往任意邮箱）

### 1.1 开启两步验证并创建「应用专用密码」

1. 登录 [Google 账号](https://myaccount.google.com/)。
2. 进入 **安全性** → 先开启 **两步验证**（若未开启）。
3. 在 **安全性** 页面找到 **应用专用密码**（或搜索「应用专用密码」）。
4. 选择应用：选 **邮件**；设备选 **其他（自定义名称）**，输入例如「存货小管家」。
5. 点 **生成**，页面上会显示 **16 位密码**（中间有空格，可去掉后使用）。  
   **请立即复制保存**，关闭页面后无法再查看。

### 1.2 在 Vercel 中配置环境变量

1. 打开 Vercel 项目 → **Settings** → **Environment Variables**。
2. 新增两条变量（Production、Preview 建议都勾选）：
   - **Key**：`SMTP_USER`  
     **Value**：你的 Gmail 地址（如 `yourname@gmail.com`）。
   - **Key**：`SMTP_PASS`  
     **Value**：上一步得到的 **16 位应用专用密码**（不是 Google 账号登录密码）。
3. 保存后，到 **Deployments** 对最新部署做一次 **Redeploy**，使环境变量生效。

配置完成后，**手动「发送今日报告到邮箱」** 以及 **定期自动发送** 都会用 Gmail 发信，可发往任意收件人。

---

## 二、仅需「手动发送」时

- 完成 **一、Gmail 配置** 即可。
- 用户在设置里填写自己的邮箱，首页点击「发送今日报告到邮箱」即会发到该邮箱。

---

## 三、需要「定期自动发送」（不打开页面也能收信）

除 Gmail 外，还需：**Vercel KV 存储** + **Cron 密钥**。

### 3.1 创建 Vercel KV 存储

1. 在 Vercel 项目里点 **Storage**（或 **Integrations** / 市场里搜 **KV**）。
2. 创建 **KV Database**（或通过 Vercel 推荐的 Redis 集成，如 Upstash）。
3. 将创建的 KV 与**当前项目关联**，关联后 Vercel 会自动注入 `KV_REST_API_URL`、`KV_REST_API_TOKEN` 等环境变量，无需手填。

若使用 **@vercel/kv**，关联后即可在 `api/register-report.js`、`api/cron-send-reports.js` 中读写订阅列表。

### 3.2 设置 Cron 密钥

1. 在 Vercel 项目 **Environment Variables** 中新增：
   - **Key**：`CRON_SECRET`  
   - **Value**：一串随机字符串（如用 `openssl rand -hex 24` 生成），仅用于校验定时任务请求。
2. 保存后 **Redeploy**。

### 3.3 定时任务说明

- 项目中的 **`vercel.json`** 已配置 Cron：每天 **0:00 UTC**（北京时间 8:00）访问 `/api/cron-send-reports`。
- 该接口会读取 KV 中的订阅列表，对「已到发送周期」的用户，用 **Gmail（SMTP）** 发送其上次同步的报告快照。
- 用户只要在设置里勾选「定期自动发送报告」并保存，之后每次打开首页时会自动把**当前报告快照**同步到服务端；Cron 按「通知频率」天数判断是否该发信。

### 3.4 小结（定期自动发送）

| 配置项 | 作用 |
|--------|------|
| **SMTP_USER + SMTP_PASS**（Gmail） | 实际发信，且可发往任意用户邮箱 |
| **Vercel KV** | 存储「谁要收、周期、上次报告快照、上次发送时间」 |
| **CRON_SECRET** | 保护 `/api/cron-send-reports`，仅允许 Vercel Cron 调用 |

---

## 四、Resend 方式（可选）

若只给自己发、且 Resend 允许你的收件地址，可仅配置 Resend：

- **Key**：`RESEND_API_KEY`  
- **Value**：在 [resend.com](https://resend.com) 创建的 API Key。

**注意**：Resend 免费版可能限制收件人，**多用户或「发到别人填的邮箱」请用 Gmail**。

---

## 五、验证是否生效

1. **手动发送**：设置里填好邮箱 → 首页点击「发送今日报告到邮箱」→ 应收到邮件或看到明确成功/失败提示。
2. **定期自动发送**：勾选「定期自动发送报告」→ 填好邮箱、选好通知频率 → 打开一次首页（同步快照）→ 等待到 Cron 执行时间，或暂时把 `vercel.json` 里 cron 的 `schedule` 改为更频繁做测试（测完改回）。

若失败，可到 Vercel → **Deployments** → 最新部署 → **Functions** → 查看 `api/send-report`、`api/register-report`、`api/cron-send-reports` 的日志排查。
