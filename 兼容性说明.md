# 版本兼容性与后续开发说明

> 发给他人使用后，后续功能迭代需保证：**现有用户数据可继续使用，Notion 同步不被破坏**。本文说明当前设计如何满足这一点，以及后续开发时应遵守的约定。

---

## 一、现有用户能否兼容？结论

**可以兼容。** 当前实现已经为「老数据、老设置」做了兜底，只要后续开发遵守下面约定，现有用户升级后不会丢数据，也不会影响未来数据同步。

---

## 二、本地数据（仅本地保存用户）

### 2.1 存货数据（localStorage `vibecoding_items`）

- **现状**：每条记录通过 `normalizeRecord()` 归一化后再参与逻辑；缺失字段会用默认值补全（如 `remindBeforeDays`、`usedUpAt`、`notionPageId` 可选）。
- **兼容要点**：
  - **新增字段**：在 `normalizeRecord()` 里为新字段写默认值，例如：  
    `newField: item.newField !== undefined ? item.newField : 默认值`  
    这样旧数据没有该字段时也会得到默认值，不会报错。
  - **不要删除或改名已有字段**：若必须改，应写一次「迁移逻辑」：根据旧结构生成新结构，再写回存储。

### 2.2 设置（localStorage `vibecoding_settings`）

- **现状**：`getSettings()` 对每一项都有默认值（如 `summaryWeeks`、`purgeUsedUpEnabled`、`purgeUsedUpWeeks` 等），读取时缺失的 key 会按默认值返回。
- **兼容要点**：
  - **新增设置项**：在 `getSettings()` 里增加新 key，并给出默认值；保存时新 key 会一并写入。  
    旧用户升级后首次打开会「缺省」使用新默认值，不会报错。

只要遵守「新字段/新设置都给默认值、不删改已有字段名」，**本地用户的数据和设置在未来版本中都会继续可用**。

---

## 三、Notion 同步用户：会不会影响未来数据同步？

### 3.1 现有逻辑

- **拉取**：Notion 页面通过 `notionPageToItem()` 转成本地 item；用 `propText` / `propNumber` / `propDate` 等读属性，**没有的属性会得到空串或 0**，不会报错。
- **写入**：`itemToNotionProperties()` 把本地 item 转成 Notion 的 properties；创建/更新页面时会把当前代码里列出的属性都发给 Notion。
- **数据库结构**：新用户通过「创建存货小管家数据库」会使用 `api/notion-proxy.js` 里 `getInventoryDatabaseSchema()` 的 schema；**老用户已有的 Notion 数据库不会自动更新**，属性列是创建时的固定那一套。

### 3.2 可能影响同步的两类改动

| 改动类型 | 风险 | 建议做法 |
|----------|------|----------|
| **在 Notion 里新增属性列**（例如新增「单位」） | 若在 `itemToNotionProperties()` 里直接写新属性，而老用户数据库没有这一列，Notion API 可能报错，导致同步失败。 | ① 新属性只对「新创建的数据库」生效（在 `getInventoryDatabaseSchema()` 里加上新列）；② 写入时**不要**把新属性发给老数据库，或先判断/兼容：例如仅当 Notion 返回的 schema 包含该属性时才写入；③ 或提供「升级数据库」的说明/工具，让用户手动在 Notion 里加一列后再用新版本。 |
| **删除或改名 Notion 已有属性** | 老数据库仍用旧属性名，拉取或写入会错位或失败。 | 避免删除或改名；若必须做，需要兼容旧属性名或提供迁移说明。 |

### 3.3 小结

- **不新增、不删改 Notion 属性**：现有 Notion 用户的同步**不会**受影响。
- **新增 Notion 属性**：只要按上面表格做（新 DB 用新 schema、老 DB 不强制写新列或先升级），**也不会破坏**现有用户的数据同步；只是老用户若想用新字段，需要自己在 Notion 里加列或走一次升级流程。

---

## 四、后续开发建议（简要清单）

1. **存货字段**：新增字段一律在 `normalizeRecord()` 中给默认值；不删除、不改名已有字段，必要时写迁移。
2. **设置项**：新增设置一律在 `getSettings()` 中给默认值。
3. **Notion**：  
   - 新属性只在 `getInventoryDatabaseSchema()` 中增加（新创建的 DB 才有）；  
   - 在 `itemToNotionProperties()` 中若写新属性，要确保老 DB 没有该列时不会报错（例如不发送该属性，或先通过 API 更新 DB schema 再写）。
4. **可选**：在 `data.js` 里增加「数据版本号」和一次性的 `migrateIfNeeded()`，每次加载时根据版本号执行对应迁移，便于以后做更复杂的数据结构升级。

按上述方式迭代，**现有用户的使用和未来的数据同步都可以保持兼容**。
