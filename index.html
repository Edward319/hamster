<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>存货小管家 — 保质期与库存管理</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="app">
    <!-- 主内容区：四个页面通过 JS 切换显示 -->
    <main class="main">
      <section id="view-home" class="view view-active" data-view="home">
        <div class="view-inner">
          <header class="page-header">
            <h1 class="page-title">今日提醒</h1>
          </header>
          <div class="hamster-card">
            <div class="hamster-character hamster-employee" aria-hidden="true"></div>
            <div class="card-content">
              <div id="home-empty-msg" class="empty-msg hidden">今天没有快过期的东西，真棒！</div>
              <p id="home-urging-msg" class="urging-msg hidden"></p>
              <div id="home-expiring-list" class="expiring-wrap"></div>
            </div>
          </div>
          <div class="home-send-email">
            <button type="button" class="btn btn-secondary" id="btn-send-report">发送今日报告到邮箱</button>
            <span id="send-report-status" class="send-status hidden"></span>
          </div>
          <section class="biweekly-section" id="home-biweekly">
            <h2 class="biweekly-title">货单总结</h2>
            <p id="biweekly-period-hint" class="biweekly-period-hint" aria-hidden="true"></p>
            <div id="biweekly-new" class="biweekly-block"></div>
            <div id="biweekly-used" class="biweekly-block"></div>
          </section>
        </div>
      </section>

      <section id="view-inventory" class="view" data-view="inventory">
        <div class="view-inner">
          <header class="page-header with-action">
            <h1 class="page-title">库存管理</h1>
            <button type="button" class="btn btn-primary btn-add" id="btn-add-item">进货</button>
          </header>
          <div class="hamster-admin">
            <div class="hamster-character hamster-admin" aria-hidden="true"></div>
            <div class="admin-table-wrap">
              <div id="inventory-stamp" class="stamp hidden" aria-hidden="true">已登记</div>
              <div class="table-scroll">
                <table class="inventory-table" id="inventory-table">
                  <thead>
                    <tr>
                      <th class="col-expand"></th>
                      <th>物品</th>
                      <th>品类</th>
                      <th>品牌</th>
                      <th>总数量</th>
                      <th>总价（元）</th>
                      <th>到期范围</th>
                    </tr>
                  </thead>
                  <tbody id="inventory-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- 筛选：在库 / 已用完 -->
          <div class="filter-bar">
            <button type="button" class="filter-btn active" data-status="in_stock">在库</button>
            <button type="button" class="filter-btn" data-status="used_up">已用完</button>
          </div>
        </div>
      </section>

      <section id="view-butler" class="view" data-view="butler">
        <div class="view-inner">
          <header class="page-header">
            <h1 class="page-title">管家</h1>
          </header>
          <div class="butler-placeholder">
            <div class="hamster-character hamster-holding-report" aria-hidden="true"></div>
            <p class="butler-desc">预留接入 DeepSeek、通义千问、豆包等大模型，实现智能管家对话与服务。</p>
            <p class="butler-hint">后续版本将支持连接自己的大模型账户，通过读取库存数据提供对话与建议。</p>
          </div>
        </div>
      </section>

      <section id="view-settings" class="view" data-view="settings">
        <div class="view-inner">
          <header class="page-header">
            <h1 class="page-title">设置</h1>
          </header>
          <div class="settings-list">
            <!-- 一级：通知 -->
            <div class="settings-group-label">通知</div>
            <div class="settings-sub-group">
              <div class="settings-sub-label">邮箱设定</div>
              <div class="setting-item">
                <label for="setting-notify-email">报告发送到指定邮箱</label>
                <input type="email" id="setting-notify-email" placeholder="填写接收报告的邮箱" />
                <span class="setting-desc">首页「发送今日报告」会把报告发到这个邮箱。</span>
              </div>
              <div class="settings-sub-label">进货总结统计周期</div>
              <div class="setting-item">
                <label for="setting-summary-weeks">统计周期（周）</label>
                <select id="setting-summary-weeks">
                  <option value="1">过去 1 周</option>
                  <option value="2">过去 2 周</option>
                  <option value="3">过去 3 周</option>
                  <option value="4">过去 4 周</option>
                  <option value="6">过去 6 周</option>
                  <option value="8">过去 8 周</option>
                  <option value="12">过去 12 周</option>
                </select>
                <span class="setting-desc">首页「货单总结」按所选周数滚动统计进货与消耗。</span>
              </div>
              <div class="settings-sub-label">通知频率</div>
              <div class="setting-item">
                <label for="setting-remind-cycle">定期向邮箱发送报告</label>
                <select id="setting-remind-cycle">
                  <option value="7">每 1 周</option>
                  <option value="14">每 2 周</option>
                  <option value="21">每 3 周</option>
                  <option value="28">每 4 周</option>
                </select>
                <span class="setting-desc">按此周期向上面邮箱发送今日报告（功能开发中，当前可手动在首页发送）。</span>
              </div>
            </div>

            <!-- 一级：数据保存 -->
            <div class="settings-group-label">数据保存</div>
            <div class="setting-item">
              <label for="setting-storage-mode">保存方式</label>
              <select id="setting-storage-mode">
                <option value="local">本地保存</option>
                <option value="notion">Notion 保存</option>
              </select>
              <span class="setting-desc" id="setting-storage-desc-local">数据只存在你这台设备的浏览器里，换设备或清空浏览器会丢失；不经过服务器，隐私最好。</span>
              <span class="setting-desc hidden" id="setting-storage-desc-notion">数据存到你自己的 Notion 里，多设备可同步；本应用不保存任何库存内容。</span>
            </div>
            <div id="local-settings-block" class="local-settings-block hidden">
              <div class="settings-sub-label">自动清理已用完数据</div>
              <div class="setting-item">
                <label for="setting-purge-used-up">启用自动删除已用完记录</label>
                <input type="checkbox" id="setting-purge-used-up" />
                <span class="setting-desc">节省本地存储空间；删除后该时段内的「消耗」统计将不再包含这些记录，可能影响货单总结等统计结果。</span>
              </div>
              <div id="purge-weeks-wrap" class="purge-weeks-wrap hidden">
                <div class="setting-item">
                  <label for="setting-purge-weeks">删除周期（周）</label>
                  <select id="setting-purge-weeks">
                    <option value="2">超过 2 周</option>
                    <option value="4">超过 4 周</option>
                    <option value="8">超过 8 周</option>
                    <option value="12">超过 12 周</option>
                    <option value="26">超过 26 周</option>
                    <option value="52">超过 52 周</option>
                  </select>
                  <span class="setting-desc">标记「用完了」且超过此时长的记录将在进入库存页时自动删除。</span>
                </div>
              </div>
            </div>
            <div id="notion-settings-block" class="notion-settings-block hidden">
              <div class="settings-sub-label">① 集成密钥</div>
              <div class="setting-item">
                <label for="setting-notion-token">集成密钥</label>
                <input type="password" id="setting-notion-token" placeholder="密钥" autocomplete="off" />
                <span class="setting-desc">打开 notion.so/my-integrations → 新建「内部集成」→ 复制密钥，粘贴到输入框。</span>
              </div>
              <div class="settings-sub-label">② 数据库</div>
              <p class="notion-db-hint">在 Notion 新建页面 → 右上角「连接」选你的集成 → 把该页面 URL 里最后一段 ID 填到「父页面 ID」→ 点「创建『存货小管家』数据库」</p>
              <div class="setting-item">
                <label for="setting-notion-parent-page-id">创建新数据库（推荐）</label>
                <input type="text" id="setting-notion-parent-page-id" placeholder="父页面 ID" autocomplete="off" />
                <button type="button" class="btn btn-secondary btn-sm" id="btn-notion-create-db">创建「存货小管家」数据库</button>
                <span class="setting-desc" id="notion-create-db-status"></span>
              </div>
              <div class="setting-item">
                <label for="setting-notion-database-id">或已有数据库</label>
                <input type="text" id="setting-notion-database-id" placeholder="数据库 ID" autocomplete="off" />
              </div>
              <div class="setting-item">
                <label>本设备配置</label>
                <button type="button" class="btn btn-secondary btn-sm" id="btn-notion-clear">清除本机 Notion 配置</button>
                <span class="setting-desc">公共电脑用完可点此清除，不会删除 Notion 里的数据。</span>
              </div>
            </div>

            <!-- 一级：AI 管家 -->
            <div class="settings-group-label">AI 管家</div>
            <div class="setting-item">
              <label>AI Agent 接入</label>
              <span class="setting-desc">后续版本可连接自己的大模型账户（DeepSeek / 千问 / 豆包等），通过读取库存数据实现管家页对话与服务</span>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- 底部导航 -->
    <nav class="bottom-nav" role="navigation">
      <button type="button" class="nav-item active" data-nav="home" aria-label="首页">
        <span class="nav-icon">🏠</span>
        <span class="nav-label">首页</span>
      </button>
      <button type="button" class="nav-item" data-nav="inventory" aria-label="库存管理">
        <span class="nav-icon">📦</span>
        <span class="nav-label">库存</span>
      </button>
      <button type="button" class="nav-item" data-nav="butler" aria-label="管家">
        <span class="nav-icon">🤖</span>
        <span class="nav-label">管家</span>
      </button>
      <button type="button" class="nav-item" data-nav="settings" aria-label="设置">
        <span class="nav-icon">⚙️</span>
        <span class="nav-label">设置</span>
      </button>
    </nav>
  </div>

  <!-- 添加/编辑 弹层：仓库申请卡片式表单 -->
  <div id="modal-form" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" id="modal-close"></div>
    <div class="modal-content form-card">
      <div class="form-card-header">
        <h2 id="form-title">登记新货物</h2>
        <button type="button" class="btn-close" id="form-close" aria-label="关闭">×</button>
      </div>
      <form id="item-form" class="item-form">
        <input type="hidden" id="item-id" name="id" />
        <div class="form-row">
          <label for="item-name">物品名称 <span class="required">*</span></label>
          <input type="text" id="item-name" name="name" required placeholder="如：鲜牛奶" />
        </div>
        <div class="form-row form-row-copy">
          <label>从已有复制</label>
          <input type="text" id="item-copy-search" placeholder="输入关键字搜索后从下拉选择" autocomplete="off" />
          <div id="item-copy-list" class="copy-list copy-list-dropdown hidden"></div>
        </div>
        <div class="form-row">
          <label for="item-category1">一级品类 <span class="required">*</span></label>
          <input type="text" id="item-category1" name="category1" list="list-category1" required placeholder="如：食品" />
          <datalist id="list-category1"></datalist>
        </div>
        <div class="form-row">
          <label for="item-category2">二级品类 <span class="required">*</span></label>
          <input type="text" id="item-category2" name="category2" list="list-category2" required placeholder="如：牛奶" />
          <datalist id="list-category2"></datalist>
        </div>
        <div class="form-row">
          <label for="item-brand">品牌 <span class="required">*</span></label>
          <input type="text" id="item-brand" name="brand" required placeholder="如：某某牌" />
        </div>
        <div class="form-row form-row-half">
          <label for="item-quantity">数量 <span class="required">*</span></label>
          <input type="number" id="item-quantity" name="quantity" min="0.001" step="any" required placeholder="1" />
        </div>
        <div class="form-row form-row-half">
          <label for="item-unit-price">单位价格（元）<span class="required">*</span></label>
          <input type="number" id="item-unit-price" name="unitPrice" min="0" step="0.01" required placeholder="0" />
        </div>
        <div class="form-row form-row-half">
          <label for="item-purchase-date">购买日期 <span class="required">*</span></label>
          <input type="date" id="item-purchase-date" name="purchaseDate" required />
        </div>
        <div class="form-row form-row-half">
          <label for="item-expiry-date">保质期/赏味期 <span class="required">*</span></label>
          <input type="date" id="item-expiry-date" name="expiryDate" required />
        </div>
        <div class="form-row">
          <label for="item-remind-days">提前多少天提醒 <span class="required">*</span></label>
          <input type="number" id="item-remind-days" name="remindBeforeDays" min="1" max="365" value="30" placeholder="30" />
          <span class="form-hint">默认 30 天，可在编辑时修改</span>
        </div>
        <div class="form-row">
          <label for="item-note">备注</label>
          <input type="text" id="item-note" name="note" placeholder="如：放冰箱上层" />
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="form-cancel">取消</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 用完了：填写本次使用数量 -->
  <div id="modal-use" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" id="modal-use-close"></div>
    <div class="modal-content modal-use-content">
      <div class="form-card-header">
        <h2>本次使用数量</h2>
        <button type="button" class="btn-close" id="modal-use-close-btn" aria-label="关闭">×</button>
      </div>
      <div class="modal-use-body">
        <p id="use-item-desc" class="use-item-desc"></p>
        <div class="form-row">
          <label for="use-quantity">数量</label>
          <input type="number" id="use-quantity" min="0" step="any" value="1" required />
          <span class="form-hint">最多 <span id="use-quantity-max">0</span></span>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="use-cancel">取消</button>
          <button type="button" class="btn btn-primary" id="use-confirm">确定</button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/data.js"></script>
  <script src="js/notion-sync.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
